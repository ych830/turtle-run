<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="NFC í‚¤ë§ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ëŸ¬ë‹ ê²Œì„! ê±¸ìœ¼ë©´ì„œ ê±°ë¶ì´ë¥¼ í‚¤ì›Œë³´ì„¸ìš”">
    <title>ğŸ¢ í„°í‹€ëŸ° - Turtle Run</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* ì˜¨ë³´ë”© í™”ë©´ */
        .onboarding {
            text-align: center;
            padding: 40px 20px;
        }

        .onboarding h1 {
            font-size: 3em;
            margin-bottom: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .onboarding-emoji {
            font-size: 150px;
            margin: 30px 0;
            animation: bounce 2s infinite;
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-30px); }
        }

        .welcome-text {
            font-size: 1.3em;
            color: #666;
            margin-bottom: 40px;
            line-height: 1.6;
        }

        .steps-guide {
            text-align: left;
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
        }

        .step-item {
            display: flex;
            align-items: center;
            margin: 20px 0;
            padding: 15px;
            background: white;
            border-radius: 10px;
        }

        .step-number {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-right: 20px;
            min-width: 50px;
        }

        .step-content h3 {
            color: #333;
            margin-bottom: 5px;
        }

        .step-content p {
            color: #666;
            font-size: 0.9em;
        }

        h1 {
            text-align: center;
            color: #667eea;
            margin-bottom: 30px;
            font-size: 2.5em;
        }

        .status-section {
            background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            color: white;
            text-align: center;
        }

        .turtle-display {
            font-size: 120px;
            margin: 20px 0;
            animation: float 3s ease-in-out infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        button {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            color: white;
        }

        .nfc-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            grid-column: 1/-1;
        }

        .start-button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stop-button {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .reset-button {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .skip-button {
            background: linear-gradient(135deg, #ccc 0%, #999 100%);
            color: white;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        #map {
            height: 400px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .items-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 25px;
        }

        .items-section h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
        }

        .item-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .item-card:hover {
            transform: scale(1.05);
        }

        .item-icon {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .item-name {
            font-size: 0.9em;
            color: #666;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 1000;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 5px solid #4CAF50;
        }

        .notification.error {
            border-left: 5px solid #f44336;
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00cc88);
            transition: width 0.5s;
            border-radius: 10px;
        }

        .turtle-island-badge {
            display: inline-block;
            background: #ffd700;
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .hidden {
            display: none;
        }

        .nfc-scanning {
            text-align: center;
            padding: 40px;
        }

        .nfc-icon {
            font-size: 100px;
            margin: 20px 0;
            animation: scan 1.5s infinite;
        }

        @keyframes scan {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.5; transform: scale(1.1); }
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }

            h1 {
                font-size: 1.8em;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .button-group {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ì˜¨ë³´ë”© í™”ë©´ -->
        <div id="onboardingScreen" class="onboarding">
            <h1>ğŸ¢ í„°í‹€ëŸ°</h1>
            <div class="onboarding-emoji">ğŸ¥š</div>
            <p class="welcome-text">
                NFC í‚¤ë§ì„ íƒœê·¸í•˜ê³ <br>
                ê±¸ìœ¼ë©´ì„œ ê±°ë¶ì´ë¥¼ í‚¤ì›Œë³´ì„¸ìš”!
            </p>

            <div class="steps-guide">
                <div class="step-item">
                    <div class="step-number">1ï¸âƒ£</div>
                    <div class="step-content">
                        <h3>NFC í‚¤ë§ íƒœê·¸</h3>
                        <p>íœ´ëŒ€í°ì„ í‚¤ë§ì— ê°€ê¹Œì´ ëŒ€ë©´ ê±°ë¶ì´ ì•Œì´ ë‚˜íƒ€ë‚˜ìš”</p>
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-number">2ï¸âƒ£</div>
                    <div class="step-content">
                        <h3>ëŸ¬ë‹ ì‹œì‘</h3>
                        <p>GPSë¡œ ì´ë™ ê²½ë¡œë¥¼ ìë™ìœ¼ë¡œ ê¸°ë¡í•´ìš”</p>
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-number">3ï¸âƒ£</div>
                    <div class="step-content">
                        <h3>ê±°ë¶ì´ ì„±ì¥</h3>
                        <p>ê±¸ìŒìˆ˜ì— ë”°ë¼ ê±°ë¶ì´ê°€ ìë¼ìš”</p>
                    </div>
                </div>
                <div class="step-item">
                    <div class="step-number">4ï¸âƒ£</div>
                    <div class="step-content">
                        <h3>ê±°ë¶ì„¬ ë°©ë¬¸</h3>
                        <p>íŠ¹ë³„í•œ ì¥ì†Œì— ê°€ë©´ ì•„ì´í…œì„ ë°›ì•„ìš”</p>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="nfc-button" onclick="startWithNFC()">
                    ğŸ“± NFC í‚¤ë§ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
                </button>
                <button class="skip-button" onclick="skipNFC()">
                    â­ï¸ NFC ì—†ì´ ì‹œì‘í•˜ê¸°
                </button>
            </div>
        </div>

        <!-- NFC ìŠ¤ìº” í™”ë©´ -->
        <div id="nfcScanScreen" class="nfc-scanning hidden">
            <div class="nfc-icon">ğŸ“¡</div>
            <h2>NFC í‚¤ë§ì„ ê°€ê¹Œì´ ëŒ€ì„¸ìš”</h2>
            <p style="color: #666; margin: 20px 0;">
                íœ´ëŒ€í° ë’·ë©´ì„ í‚¤ë§ì— ë”± ë¶™ì—¬ì£¼ì„¸ìš”
            </p>
            <button class="skip-button" onclick="cancelNFCScan()">
                ì·¨ì†Œ
            </button>
        </div>

        <!-- ë©”ì¸ ê²Œì„ í™”ë©´ -->
        <div id="gameScreen" class="hidden">
            <h1>ğŸ¢ í„°í‹€ëŸ° (Turtle Run)</h1>

            <div class="status-section">
                <div class="turtle-display" id="turtleEmoji">ğŸ¥š</div>
                <h2 id="turtleStage">ê±°ë¶ì´ ì•Œ</h2>
                <div id="islandBadge"></div>
                
                <div class="progress-bar">
                    <div class="progress-fill" id="progressBar" style="width: 0%"></div>
                </div>

                <div class="stats">
                    <div class="stat-item">
                        <div class="stat-label">ê±¸ìŒìˆ˜</div>
                        <div class="stat-value" id="steps">0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ê±°ë¦¬ (km)</div>
                        <div class="stat-value" id="distance">0.0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">ë ˆë²¨</div>
                        <div class="stat-value" id="level">1</div>
                    </div>
                </div>
            </div>

            <div class="button-group">
                <button class="start-button" id="startButton" onclick="startTracking()">
                    â–¶ï¸ ëŸ¬ë‹ ì‹œì‘
                </button>
                <button class="stop-button" id="stopButton" onclick="stopTracking()" disabled>
                    â¸ï¸ ëŸ¬ë‹ ì¤‘ì§€
                </button>
                <button class="nfc-button" onclick="scanNFCAgain()">
                    ğŸ“± NFC ë‹¤ì‹œ íƒœê·¸
                </button>
                <button class="reset-button" onclick="resetProgress()">
                    ğŸ”„ ì²˜ìŒë¶€í„°
                </button>
            </div>

            <div id="map"></div>

            <div class="items-section">
                <h2>ğŸ íšë“í•œ ì•„ì´í…œ</h2>
                <div class="items-grid" id="itemsGrid">
                    <div style="text-align: center; grid-column: 1/-1; color: #999; padding: 20px;">
                        ì•„ì§ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤. ê±°ë¶ì„¬ì„ ë°©ë¬¸í•´ë³´ì„¸ìš”! ğŸï¸
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="notification" id="notification">
        <div id="notificationText"></div>
    </div>

    <script>
        // ê²Œì„ ìƒíƒœ
        let gameState = {
            turtleStage: 0,
            steps: 0,
            distance: 0,
            level: 1,
            items: [],
            isTracking: false,
            hasScannedNFC: false,
            hasStarted: false
        };

        // í™”ë©´ ê´€ë¦¬
        const screens = {
            onboarding: document.getElementById('onboardingScreen'),
            nfcScan: document.getElementById('nfcScanScreen'),
            game: document.getElementById('gameScreen')
        };

        // ì§€ë„ ê´€ë ¨
        let map;
        let currentPath = [];
        let pathPolyline;
        let currentMarker;
        let watchId;

        // ê±°ë¶ì„¬ ìœ„ì¹˜
        const TURTLE_ISLAND = {
            lat: 37.4563,
            lng: 126.7052,
            radius: 100
        };

        // ê±°ë¶ì´ ì„±ì¥ ë‹¨ê³„
        const TURTLE_STAGES = [
            { emoji: 'ğŸ¥š', name: 'ê±°ë¶ì´ ì•Œ', stepsRequired: 0 },
            { emoji: 'ğŸ¢', name: 'ì•„ê¸° ê±°ë¶ì´', stepsRequired: 1000 },
            { emoji: 'ğŸ¢', name: 'ì„±ì²´ ê±°ë¶ì´', stepsRequired: 5000 },
            { emoji: 'ğŸ²', name: 'ì „ì„¤ì˜ ê±°ë¶ì´', stepsRequired: 10000 }
        ];

        // ì•„ì´í…œ ëª©ë¡
        const ITEMS = [
            { icon: 'ğŸ–ï¸', name: 'ê±°ë¶ì„¬ ë±ƒì§€' },
            { icon: 'ğŸ†', name: 'ì™„ì£¼ íŠ¸ë¡œí”¼' },
            { icon: 'â­', name: 'ë³„ ì¡°ê°' },
            { icon: 'ğŸ’', name: 'ë³´ì„' },
            { icon: 'ğŸ¯', name: 'ëª©í‘œ ë‹¬ì„±' },
            { icon: 'ğŸ”¥', name: 'ì—°ì† ê¸°ë¡' }
        ];

        // í™”ë©´ ì „í™˜
        function showScreen(screenName) {
            Object.values(screens).forEach(screen => screen.classList.add('hidden'));
            screens[screenName].classList.remove('hidden');
        }

        // NFCë¡œ ì‹œì‘
        async function startWithNFC() {
            if (!('NDEFReader' in window)) {
                showNotification('ì´ ê¸°ê¸°ëŠ” NFCë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ ğŸ˜¢<br>NFC ì—†ì´ ì‹œì‘í•˜ê¸°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!', 'error');
                return;
            }

            showScreen('nfcScan');
            
            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                
                ndef.addEventListener("reading", ({ message, serialNumber }) => {
                    console.log(`NFC íƒœê·¸ ê°ì§€: ${serialNumber}`);
                    onNFCDetected();
                });

            } catch (error) {
                console.error('NFC ì—ëŸ¬:', error);
                showNotification('NFC ìŠ¤ìº”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ ğŸ˜¢', 'error');
                showScreen('onboarding');
            }
        }

        // NFC ê°ì§€ ì‹œ
        function onNFCDetected() {
            gameState.hasScannedNFC = true;
            gameState.hasStarted = true;
            gameState.turtleStage = 0;
            
            showNotification('ğŸ‰ ê±°ë¶ì´ ì•Œì´ ë‚˜íƒ€ë‚¬ìŠµë‹ˆë‹¤!', 'success');
            initGame();
        }

        // NFC ì—†ì´ ì‹œì‘
        function skipNFC() {
            gameState.hasStarted = true;
            initGame();
        }

        // NFC ìŠ¤ìº” ì·¨ì†Œ
        function cancelNFCScan() {
            showScreen('onboarding');
        }

        // NFC ë‹¤ì‹œ íƒœê·¸
        function scanNFCAgain() {
            startWithNFC();
        }

        // ê²Œì„ ì´ˆê¸°í™”
        function initGame() {
            showScreen('game');
            initMap();
            loadGameState();
            updateUI();
        }

        // ì§€ë„ ì´ˆê¸°í™”
        function initMap() {
            if (map) return; // ì´ë¯¸ ì´ˆê¸°í™”ë¨

            map = L.map('map').setView([TURTLE_ISLAND.lat, TURTLE_ISLAND.lng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // ê±°ë¶ì„¬ ë§ˆì»¤
            const islandIcon = L.divIcon({
                html: 'ğŸï¸',
                className: 'island-marker',
                iconSize: [40, 40]
            });
            
            L.marker([TURTLE_ISLAND.lat, TURTLE_ISLAND.lng], {icon: islandIcon})
                .addTo(map)
                .bindPopup('<b>ğŸ¢ ê±°ë¶ì„¬</b><br>ì—¬ê¸°ì— ë„ì°©í•˜ë©´ íŠ¹ë³„í•œ ì•„ì´í…œì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”!');

            // ê±°ë¶ì„¬ ë²”ìœ„ í‘œì‹œ
            L.circle([TURTLE_ISLAND.lat, TURTLE_ISLAND.lng], {
                color: '#4facfe',
                fillColor: '#4facfe',
                fillOpacity: 0.2,
                radius: TURTLE_ISLAND.radius
            }).addTo(map);
        }

        // ëŸ¬ë‹ ì‹œì‘
        function startTracking() {
            if (!navigator.geolocation) {
                showNotification('ì´ ê¸°ê¸°ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤ ğŸ˜¢', 'error');
                return;
            }

            gameState.isTracking = true;
            currentPath = [];

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    updateLocation(latitude, longitude);
                },
                (error) => {
                    console.error('ìœ„ì¹˜ ì—ëŸ¬:', error);
                    if (error.code === 1) {
                        showNotification('ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”!', 'error');
                    } else {
                        showNotification('ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤ ğŸ˜¢', 'error');
                    }
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                }
            );

            document.getElementById('startButton').disabled = true;
            document.getElementById('stopButton').disabled = false;
            showNotification('ëŸ¬ë‹ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸƒâ€â™‚ï¸', 'success');
        }

        // ëŸ¬ë‹ ì¤‘ì§€
        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }

            gameState.isTracking = false;
            document.getElementById('startButton').disabled = false;
            document.getElementById('stopButton').disabled = true;
            showNotification('ëŸ¬ë‹ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ì–´ìš”! ğŸ’ª', 'success');
            saveGameState();
        }

        // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        function updateLocation(lat, lng) {
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            const icon = L.divIcon({
                html: 'ğŸ“',
                className: 'current-marker',
                iconSize: [30, 30]
            });

            currentMarker = L.marker([lat, lng], {icon: icon}).addTo(map);
            map.setView([lat, lng], map.getZoom());

            if (currentPath.length > 0) {
                const lastPoint = currentPath[currentPath.length - 1];
                const distance = calculateDistance(lastPoint[0], lastPoint[1], lat, lng);
                
                if (distance > 0.005) {
                    currentPath.push([lat, lng]);
                    gameState.distance += distance;
                    gameState.steps += Math.floor(distance * 1500);
                    
                    updatePath();
                    checkTurtleGrowth();
                    checkIslandProximity(lat, lng);
                    updateUI();
                    saveGameState();
                }
            } else {
                currentPath.push([lat, lng]);
            }
        }

        // ê²½ë¡œ ê·¸ë¦¬ê¸°
        function updatePath() {
            if (pathPolyline) {
                map.removeLayer(pathPolyline);
            }

            if (currentPath.length > 1) {
                pathPolyline = L.polyline(currentPath, {
                    color: '#667eea',
                    weight: 4,
                    opacity: 0.7
                }).addTo(map);
            }
        }

        // ê±°ë¦¬ ê³„ì‚°
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ê±°ë¶ì´ ì„±ì¥ ì²´í¬
        function checkTurtleGrowth() {
            for (let i = TURTLE_STAGES.length - 1; i >= 0; i--) {
                if (gameState.steps >= TURTLE_STAGES[i].stepsRequired && gameState.turtleStage < i) {
                    gameState.turtleStage = i;
                    gameState.level = i + 1;
                    showNotification(`ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ${TURTLE_STAGES[i].name}ë¡œ ì„±ì¥í–ˆìŠµë‹ˆë‹¤!`, 'success');
                    break;
                }
            }
        }

        // ê±°ë¶ì„¬ ê·¼ì²˜ ì²´í¬
        function checkIslandProximity(lat, lng) {
            const distance = calculateDistance(lat, lng, TURTLE_ISLAND.lat, TURTLE_ISLAND.lng) * 1000;
            
            if (distance <= TURTLE_ISLAND.radius) {
                const hasIslandBadge = gameState.items.some(item => item.name === 'ê±°ë¶ì„¬ ë±ƒì§€');
                
                if (!hasIslandBadge) {
                    gameState.items.push(ITEMS[0]);
                    gameState.items.push(ITEMS[2]);
                    showNotification('ğŸŠ ê±°ë¶ì„¬ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤! íŠ¹ë³„í•œ ì•„ì´í…œì„ ë°›ì•˜ì–´ìš”!', 'success');
                    updateItemsDisplay();
                    saveGameState();
                }
                
                document.getElementById('islandBadge').innerHTML = 
                    '<div class="turtle-island-badge">ğŸï¸ ê±°ë¶ì„¬ ë°©ë¬¸ ì¤‘</div>';
            } else {
                document.getElementById('islandBadge').innerHTML = '';
            }
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            const stage = TURTLE_STAGES[gameState.turtleStage];
            document.getElementById('turtleEmoji').textContent = stage.emoji;
            document.getElementById('turtleStage').textContent = stage.name;
            document.getElementById('steps').textContent = gameState.steps.toLocaleString();
            document.getElementById('distance').textContent = gameState.distance.toFixed(2);
            document.getElementById('level').textContent = gameState.level;

            let progress = 0;
            if (gameState.turtleStage < TURTLE_STAGES.length - 1) {
                const currentRequired = TURTLE_STAGES[gameState.turtleStage].stepsRequired;
                const nextRequired = TURTLE_STAGES[gameState.turtleStage + 1].stepsRequired;
                progress = ((gameState.steps - currentRequired) / (nextRequired - currentRequired)) * 100;
            } else {
                progress = 100;
            }
            document.getElementById('progressBar').style.width = Math.min(progress, 100) + '%';
        }

        // ì•„ì´í…œ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateItemsDisplay() {
            const grid = document.getElementById('itemsGrid');
            
            if (gameState.items.length === 0) {
                grid.innerHTML = '<div style="text-align: center; grid-column: 1/-1; color: #999; padding: 20px;">ì•„ì§ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤. ê±°ë¶ì„¬ì„ ë°©ë¬¸í•´ë³´ì„¸ìš”! ğŸï¸</div>';
            } else {
                grid.innerHTML = gameState.items.map(item => `
                    <div class="item-card">
                        <div class="item-icon">${item.icon}</div>
                        <div class="item-name">${item.name}</div>
                    </div>
                `).join('');
            }
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showNotification(text, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.innerHTML = text;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ì§„í–‰ìƒí™© ì´ˆê¸°í™”
        function resetProgress() {
            if (!confirm('ì •ë§ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ëª¨ë“  ì§„í–‰ìƒí™©ì´ ì‚­ì œë©ë‹ˆë‹¤.')) {
                return;
            }

            gameState = {
                turtleStage: 0,
                steps: 0,
                distance: 0,
                level: 1,
                items: [],
                isTracking: false,
                hasScannedNFC: false,
                hasStarted: false
            };

            currentPath = [];
            if (pathPolyline) map.removeLayer(pathPolyline);
            if (currentMarker) map.removeLayer(currentMarker);

            updateUI();
            updateItemsDisplay();
            saveGameState();
            showNotification('ì§„í–‰ìƒí™©ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            showScreen('onboarding');
        }

        // ì €ì¥
        function saveGameState() {
            localStorage.setItem('turtleRunState', JSON.stringify(gameState));
        }

        // ë¶ˆëŸ¬ì˜¤ê¸°
        function loadGameState() {
            const saved = localStorage.getItem('turtleRunState');
            if (saved) {
                const loaded = JSON.parse(saved);
                gameState = { ...gameState, ...loaded };
                updateItemsDisplay();
            }
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ
        window.addEventListener('load', () => {
            loadGameState();
            
            // ì´ë¯¸ ê²Œì„ì„ ì‹œì‘í•œ ì ì´ ìˆìœ¼ë©´ ê²Œì„ í™”ë©´ìœ¼ë¡œ
            if (gameState.hasStarted) {
                initGame();
            }
        });

        // URL íŒŒë¼ë¯¸í„°ë¡œ NFC ê°ì§€ (ì„ íƒì‚¬í•­)
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('nfc') === 'detected') {
            onNFCDetected();
        }
    </script>
</body>
</html>
