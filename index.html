<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="NFC í‚¤ë§ìœ¼ë¡œ ì‹œì‘í•˜ëŠ” ëŸ¬ë‹ ê²Œì„! ê±¸ìœ¼ë©´ì„œ ê±°ë¶ì´ë¥¼ í‚¤ì›Œë³´ì„¸ìš”">
    <title>ğŸ¢ í„°í‹€ëŸ° - Turtle Run</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }

        /* í—¤ë” ë¡œê³  */
        .header-with-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid #f0f0f0;
            position: relative;
        }

        .logo {
            width: 80px;
            height: 80px;
            animation: logoFloat 3s ease-in-out infinite;
        }

        @keyframes logoFloat {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
        }

        .header-with-logo h1 {
            margin: 0;
            color: #667eea;
            font-size: 2em;
        }

        /* VIP ë°°ì§€ */
        .vip-badge {
            position: absolute;
            top: -10px;
            right: 10px;
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            color: #333;
            padding: 8px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4);
            animation: vipGlow 2s infinite;
            display: none;
        }

        .vip-badge.active {
            display: block;
        }

        @keyframes vipGlow {
            0%, 100% { box-shadow: 0 4px 15px rgba(255, 215, 0, 0.4); }
            50% { box-shadow: 0 4px 25px rgba(255, 215, 0, 0.8); }
        }

        .status-section {
            background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            color: white;
            text-align: center;
        }

        .turtle-display {
            font-size: 120px;
            margin: 20px 0;
            animation: float 3s ease-in-out infinite;
            cursor: pointer;
            transition: transform 0.3s;
        }

        .turtle-display:hover {
            transform: scale(1.1);
        }

        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }

        /* ê±°ë¶ì´ ì´ë¦„ */
        .turtle-name {
            font-size: 1.5em;
            margin: 10px 0;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .turtle-name.editable {
            cursor: pointer;
            text-decoration: underline dotted;
        }

        .turtle-name.editable:hover {
            transform: scale(1.05);
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .button-group {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
        }

        button {
            padding: 15px 30px;
            font-size: 1.1em;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            color: white;
        }

        .nfc-button {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .start-button {
            background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
        }

        .stop-button {
            background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        }

        .reset-button {
            background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
            color: #333;
        }

        .customize-button {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            color: #333;
            grid-column: 1/-1;
            display: none;
        }

        .customize-button.active {
            display: block;
        }

        button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        #map {
            height: 400px;
            border-radius: 15px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* ì»¤ìŠ¤í„°ë§ˆì´ì§• íŒ¨ë„ */
        .customize-panel {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            display: none;
        }

        .customize-panel.active {
            display: block;
        }

        .customize-panel h3 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .customize-section {
            margin: 20px 0;
        }

        .customize-section label {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
            color: #333;
        }

        .name-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 10px;
            font-size: 1.1em;
            transition: border 0.3s;
        }

        .name-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .emoji-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
        }

        .emoji-option {
            font-size: 2.5em;
            padding: 10px;
            cursor: pointer;
            border: 3px solid transparent;
            border-radius: 10px;
            transition: all 0.3s;
            text-align: center;
        }

        .emoji-option:hover {
            transform: scale(1.2);
            background: rgba(102, 126, 234, 0.1);
        }

        .emoji-option.selected {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.2);
        }

        .color-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 15px;
        }

        .color-option {
            height: 60px;
            border-radius: 10px;
            cursor: pointer;
            border: 3px solid transparent;
            transition: all 0.3s;
        }

        .color-option:hover {
            transform: scale(1.1);
        }

        .color-option.selected {
            border-color: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.3);
        }

        .items-section {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            margin-top: 25px;
        }

        .items-section h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 15px;
        }

        .item-card {
            background: white;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }

        .item-card:hover {
            transform: scale(1.05);
        }

        .item-card.legendary {
            background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
            animation: legendary 2s infinite;
        }

        @keyframes legendary {
            0%, 100% { box-shadow: 0 2px 5px rgba(255,215,0,0.5); }
            50% { box-shadow: 0 5px 20px rgba(255,215,0,0.8); }
        }

        .item-icon {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .item-name {
            font-size: 0.9em;
            color: #666;
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 20px 30px;
            border-radius: 10px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.3);
            transform: translateX(400px);
            transition: transform 0.3s;
            z-index: 1000;
            max-width: 300px;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            border-left: 5px solid #4CAF50;
        }

        .notification.error {
            border-left: 5px solid #f44336;
        }

        .notification.vip {
            border-left: 5px solid #ffd700;
            background: linear-gradient(135deg, #fff9e6 0%, #ffffff 100%);
        }

        .progress-bar {
            width: 100%;
            height: 20px;
            background: rgba(255,255,255,0.3);
            border-radius: 10px;
            overflow: hidden;
            margin: 15px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00ff88, #00cc88);
            transition: width 0.5s;
            border-radius: 10px;
        }

        .turtle-island-badge {
            display: inline-block;
            background: #ffd700;
            color: #333;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            margin-top: 10px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }

        .modal-close {
            float: right;
            font-size: 2em;
            cursor: pointer;
            color: #999;
        }

        .modal-close:hover {
            color: #333;
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }

            .header-with-logo h1 {
                font-size: 1.5em;
            }

            .logo {
                width: 60px;
                height: 60px;
            }

            .stats {
                grid-template-columns: 1fr;
            }

            .button-group {
                grid-template-columns: 1fr;
            }

            .emoji-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .color-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- í—¤ë”ì— ë¡œê³ ì™€ ì œëª© -->
        <div class="header-with-logo">
            <img src="logo.png" alt="Turtle Run Logo" class="logo">
            <h1>í„°í‹€ëŸ°</h1>
            <div class="vip-badge" id="vipBadge">ğŸ‘‘ VIP</div>
        </div>

        <div class="status-section">
            <div class="turtle-display" id="turtleEmoji" onclick="showCustomizeIfVIP()">ğŸ¥š</div>
            <div class="turtle-name" id="turtleName">ê±°ë¶ì´ ì•Œ</div>
            <h3 id="turtleStage">ë ˆë²¨ 1</h3>
            <div id="islandBadge"></div>
            
            <div class="progress-bar">
                <div class="progress-fill" id="progressBar" style="width: 0%"></div>
            </div>

            <div class="stats">
                <div class="stat-item">
                    <div class="stat-label">ê±¸ìŒìˆ˜</div>
                    <div class="stat-value" id="steps">0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ê±°ë¦¬ (km)</div>
                    <div class="stat-value" id="distance">0.0</div>
                </div>
                <div class="stat-item">
                    <div class="stat-label">ë ˆë²¨</div>
                    <div class="stat-value" id="level">1</div>
                </div>
            </div>
        </div>

        <!-- ì»¤ìŠ¤í„°ë§ˆì´ì§• ë²„íŠ¼ (NFC ì „ìš©) -->
        <button class="customize-button" id="customizeButton" onclick="openCustomizeModal()">
            âœ¨ ê±°ë¶ì´ ì»¤ìŠ¤í„°ë§ˆì´ì§• (VIP ì „ìš©)
        </button>

        <div class="button-group">
            <button class="start-button" id="startButton" onclick="startTracking()">
                â–¶ï¸ ëŸ¬ë‹ ì‹œì‘
            </button>
            <button class="stop-button" id="stopButton" onclick="stopTracking()" disabled>
                â¸ï¸ ëŸ¬ë‹ ì¤‘ì§€
            </button>
            <button class="nfc-button" onclick="scanNFC()">
                ğŸ“± NFC íƒœê·¸
            </button>
            <button class="reset-button" onclick="resetProgress()">
                ğŸ”„ ì²˜ìŒë¶€í„°
            </button>
        </div>

        <div id="map"></div>

        <div class="items-section">
            <h2>ğŸ íšë“í•œ ì•„ì´í…œ</h2>
            <div class="items-grid" id="itemsGrid">
                <div style="text-align: center; grid-column: 1/-1; color: #999; padding: 20px;">
                    ì•„ì§ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤. ê±°ë¶ì„¬ì„ ë°©ë¬¸í•´ë³´ì„¸ìš”! ğŸï¸
                </div>
            </div>
        </div>
    </div>

    <!-- ì»¤ìŠ¤í„°ë§ˆì´ì§• ëª¨ë‹¬ -->
    <div class="modal" id="customizeModal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeCustomizeModal()">&times;</span>
            <h2 style="color: #667eea; margin-bottom: 20px;">âœ¨ ê±°ë¶ì´ ì»¤ìŠ¤í„°ë§ˆì´ì§•</h2>

            <div class="customize-section">
                <label>ğŸ“ ê±°ë¶ì´ ì´ë¦„</label>
                <input type="text" class="name-input" id="turtleNameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="10">
            </div>

            <div class="customize-section">
                <label>ğŸ¢ ê±°ë¶ì´ ëª¨ì–‘</label>
                <div class="emoji-grid" id="emojiGrid"></div>
            </div>

            <div class="customize-section">
                <label>ğŸ¨ í…Œë§ˆ ìƒ‰ìƒ</label>
                <div class="color-grid" id="colorGrid"></div>
            </div>

            <button class="start-button" style="width: 100%; margin-top: 20px;" onclick="saveCustomization()">
                ğŸ’¾ ì €ì¥í•˜ê¸°
            </button>
        </div>
    </div>

    <div class="notification" id="notification">
        <div id="notificationText"></div>
    </div>

    <script>
        // ê²Œì„ ìƒíƒœ
        let gameState = {
            turtleStage: 0,
            steps: 0,
            distance: 0,
            level: 1,
            items: [],
            isTracking: false,
            hasScannedNFC: false,
            isVIP: false,
            customization: {
                name: '',
                emoji: 'ğŸ¥š',
                colorTheme: 'default'
            }
        };

        // ì§€ë„ ê´€ë ¨
        let map;
        let currentPath = [];
        let pathPolyline;
        let currentMarker;
        let watchId;
        let secretMarkers = [];

        // ê±°ë¶ì„¬ ìœ„ì¹˜ (ì‹œí¥ ì •ì™•ë™ í™©í•´ ê±°ë¶ì„¬)
        const TURTLE_ISLAND = {
            lat: 37.321150,
            lng: 126.678973,
            radius: 150
        };

        // ë¹„ë°€ ì¥ì†Œ (NFC ì‚¬ìš©ì ì „ìš©)
        const SECRET_LOCATIONS = [
            {
                name: 'ë¹„ë°€ ê±°ë¶ì„¬',
                emoji: 'ğŸï¸',
                lat: 37.322,
                lng: 126.680,
                radius: 100,
                reward: { icon: 'ğŸ’', name: 'ë¹„ë°€ì˜ ìˆ˜ì •' }
            },
            {
                name: 'ì‹ ë¹„ì˜ í•´ë³€',
                emoji: 'ğŸŒŠ',
                lat: 37.320,
                lng: 126.677,
                radius: 100,
                reward: { icon: 'âš¡', name: 'ë²ˆê°œ ê±°ë¶' }
            },
            {
                name: 'í™©ê¸ˆ ì‚°',
                emoji: 'â›°ï¸',
                lat: 37.323,
                lng: 126.681,
                radius: 100,
                reward: { icon: 'ğŸ‘‘', name: 'í™©ê¸ˆ ì™•ê´€' }
            }
        ];

        // ê±°ë¶ì´ ì„±ì¥ ë‹¨ê³„
        const TURTLE_STAGES = [
            { emoji: 'ğŸ¥š', name: 'ê±°ë¶ì´ ì•Œ', stepsRequired: 0 },
            { emoji: 'ğŸ¢', name: 'ì•„ê¸° ê±°ë¶ì´', stepsRequired: 1000 },
            { emoji: 'ğŸ¢', name: 'ì„±ì²´ ê±°ë¶ì´', stepsRequired: 5000 },
            { emoji: 'ğŸ²', name: 'ì „ì„¤ì˜ ê±°ë¶ì´', stepsRequired: 10000 }
        ];

        // ì»¤ìŠ¤í„°ë§ˆì´ì§• ì˜µì…˜
        const EMOJI_OPTIONS = ['ğŸ¥š', 'ğŸ¢', 'ğŸ²', 'ğŸ¦•', 'ğŸ¦–', 'ğŸŠ', 'ğŸ¦', 'ğŸ', 'ğŸ¦‘', 'ğŸ™', 
                               'ğŸ¦€', 'ğŸ¦', 'ğŸ¦', 'ğŸ ', 'ğŸŸ', 'ğŸ¡', 'ğŸ¦ˆ', 'ğŸ³', 'ğŸ¬', 'ğŸ¦­'];

        const COLOR_THEMES = [
            { name: 'default', gradient: 'linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%)' },
            { name: 'sunset', gradient: 'linear-gradient(135deg, #fa709a 0%, #fee140 100%)' },
            { name: 'forest', gradient: 'linear-gradient(135deg, #00b09b 0%, #96c93d 100%)' },
            { name: 'galaxy', gradient: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)' },
            { name: 'fire', gradient: 'linear-gradient(135deg, #f5576c 0%, #f093fb 100%)' },
            { name: 'ocean', gradient: 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)' },
            { name: 'gold', gradient: 'linear-gradient(135deg, #ffd700 0%, #ffed4e 100%)' }
        ];

        // ì•„ì´í…œ ëª©ë¡
        const ITEMS = [
            { icon: 'ğŸ–ï¸', name: 'ê±°ë¶ì„¬ ë±ƒì§€', legendary: false },
            { icon: 'ğŸ†', name: 'ì™„ì£¼ íŠ¸ë¡œí”¼', legendary: false },
            { icon: 'â­', name: 'ë³„ ì¡°ê°', legendary: false },
            { icon: 'ğŸ’', name: 'ë¹„ë°€ì˜ ìˆ˜ì •', legendary: true },
            { icon: 'âš¡', name: 'ë²ˆê°œ ê±°ë¶', legendary: true },
            { icon: 'ğŸ‘‘', name: 'í™©ê¸ˆ ì™•ê´€', legendary: true }
        ];

        // ì´ˆê¸°í™”
        function init() {
            // URL íŒŒë¼ë¯¸í„° ì²´í¬ (NFC íƒœê·¸ë¡œ ì ‘ì† ì‹œ)
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('nfc') === 'vip') {
                activateVIPMode();
            }

            // ì§€ë„ ì´ˆê¸°í™”
            map = L.map('map').setView([TURTLE_ISLAND.lat, TURTLE_ISLAND.lng], 15);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: 'Â© OpenStreetMap contributors'
            }).addTo(map);

            // ì¼ë°˜ ê±°ë¶ì„¬ ë§ˆì»¤
            const islandIcon = L.divIcon({
                html: 'ğŸï¸',
                className: 'island-marker',
                iconSize: [40, 40]
            });
            
            L.marker([TURTLE_ISLAND.lat, TURTLE_ISLAND.lng], {icon: islandIcon})
                .addTo(map)
                .bindPopup('<b>ğŸ¢ ê±°ë¶ì„¬</b><br>ì—¬ê¸°ì— ë„ì°©í•˜ë©´ íŠ¹ë³„í•œ ì•„ì´í…œì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”!');

            L.circle([TURTLE_ISLAND.lat, TURTLE_ISLAND.lng], {
                color: '#4facfe',
                fillColor: '#4facfe',
                fillOpacity: 0.2,
                radius: TURTLE_ISLAND.radius
            }).addTo(map);

            // VIP ìƒíƒœë©´ ë¹„ë°€ ì¥ì†Œ í‘œì‹œ
            if (gameState.isVIP) {
                showSecretLocations();
            }

            // ì»¤ìŠ¤í„°ë§ˆì´ì§• ì˜µì…˜ ë Œë”ë§
            renderEmojiOptions();
            renderColorOptions();

            // ì €ì¥ëœ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸°
            loadGameState();
            updateUI();
        }

        // VIP ëª¨ë“œ í™œì„±í™”
        function activateVIPMode() {
            gameState.isVIP = true;
            document.getElementById('vipBadge').classList.add('active');
            document.getElementById('customizeButton').classList.add('active');
            showNotification('ğŸ‰ VIP ëª¨ë“œ í™œì„±í™”! íŠ¹ë³„í•œ ê¸°ëŠ¥ì´ í•´ê¸ˆë˜ì—ˆìŠµë‹ˆë‹¤!', 'vip');
            
            // ë¹„ë°€ ì¥ì†Œ í‘œì‹œ
            setTimeout(() => {
                showSecretLocations();
                showNotification('ğŸ—ºï¸ ë¹„ë°€ ì¥ì†Œ 3ê³³ì´ ì§€ë„ì— í‘œì‹œë˜ì—ˆìŠµë‹ˆë‹¤!', 'vip');
            }, 2000);
            
            saveGameState();
        }

        // ë¹„ë°€ ì¥ì†Œ í‘œì‹œ (NFC ì „ìš©)
        function showSecretLocations() {
            SECRET_LOCATIONS.forEach(location => {
                const secretIcon = L.divIcon({
                    html: location.emoji,
                    className: 'secret-marker',
                    iconSize: [40, 40]
                });
                
                const marker = L.marker([location.lat, location.lng], {icon: secretIcon})
                    .addTo(map)
                    .bindPopup(`<b>${location.name}</b><br>VIP ì „ìš© ë¹„ë°€ ì¥ì†Œ!<br>ë„ì°©í•˜ë©´ ${location.reward.icon} ${location.reward.name} íšë“!`);
                
                L.circle([location.lat, location.lng], {
                    color: '#ffd700',
                    fillColor: '#ffd700',
                    fillOpacity: 0.2,
                    radius: location.radius
                }).addTo(map);

                secretMarkers.push(marker);
            });
        }

        // ì´ëª¨ì§€ ì˜µì…˜ ë Œë”ë§
        function renderEmojiOptions() {
            const grid = document.getElementById('emojiGrid');
            grid.innerHTML = EMOJI_OPTIONS.map(emoji => `
                <div class="emoji-option" onclick="selectEmoji('${emoji}')">${emoji}</div>
            `).join('');
        }

        // ìƒ‰ìƒ í…Œë§ˆ ì˜µì…˜ ë Œë”ë§
        function renderColorOptions() {
            const grid = document.getElementById('colorGrid');
            grid.innerHTML = COLOR_THEMES.map(theme => `
                <div class="color-option" style="background: ${theme.gradient}" 
                     onclick="selectColor('${theme.name}')"></div>
            `).join('');
        }

        // ì´ëª¨ì§€ ì„ íƒ
        function selectEmoji(emoji) {
            document.querySelectorAll('.emoji-option').forEach(el => {
                el.classList.remove('selected');
                if (el.textContent === emoji) {
                    el.classList.add('selected');
                }
            });
        }

        // ìƒ‰ìƒ ì„ íƒ
        function selectColor(themeName) {
            const options = document.querySelectorAll('.color-option');
            options.forEach((el, index) => {
                el.classList.remove('selected');
                if (COLOR_THEMES[index].name === themeName) {
                    el.classList.add('selected');
                }
            });
        }

        // ì»¤ìŠ¤í„°ë§ˆì´ì§• ëª¨ë‹¬ ì—´ê¸°
        function openCustomizeModal() {
            if (!gameState.isVIP) {
                showNotification('VIP ì „ìš© ê¸°ëŠ¥ì…ë‹ˆë‹¤. NFC íƒœê·¸ë¥¼ ìŠ¤ìº”í•´ì£¼ì„¸ìš”!', 'error');
                return;
            }
            document.getElementById('customizeModal').classList.add('active');
            
            // í˜„ì¬ ì„¤ì • í‘œì‹œ
            document.getElementById('turtleNameInput').value = gameState.customization.name;
        }

        // ì»¤ìŠ¤í„°ë§ˆì´ì§• ì €ì¥
        function saveCustomization() {
            const name = document.getElementById('turtleNameInput').value.trim();
            const selectedEmoji = document.querySelector('.emoji-option.selected');
            const selectedColor = document.querySelector('.color-option.selected');
            
            if (name) {
                gameState.customization.name = name;
            }
            
            if (selectedEmoji) {
                gameState.customization.emoji = selectedEmoji.textContent;
            }
            
            if (selectedColor) {
                const colorIndex = Array.from(document.querySelectorAll('.color-option')).indexOf(selectedColor);
                gameState.customization.colorTheme = COLOR_THEMES[colorIndex].name;
            }
            
            updateUI();
            saveGameState();
            closeCustomizeModal();
            showNotification('âœ¨ ì»¤ìŠ¤í„°ë§ˆì´ì§•ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }

        // ëª¨ë‹¬ ë‹«ê¸°
        function closeCustomizeModal() {
            document.getElementById('customizeModal').classList.remove('active');
        }

        // ì»¤ìŠ¤í„°ë§ˆì´ì§• í‘œì‹œ (VIPë§Œ)
        function showCustomizeIfVIP() {
            if (gameState.isVIP) {
                openCustomizeModal();
            }
        }

        // NFC ìŠ¤ìº”
        async function scanNFC() {
            if (!('NDEFReader' in window)) {
                showNotification('ì´ ê¸°ê¸°ëŠ” NFCë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. Android Chromeì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤!', 'error');
                return;
            }

            try {
                const ndef = new NDEFReader();
                showNotification('NFC íƒœê·¸ë¥¼ í‚¤ë§ì— ê°€ê¹Œì´ ëŒ€ì„¸ìš”...', 'success');
                
                await ndef.scan();
                
                ndef.addEventListener("reading", ({ message, serialNumber }) => {
                    console.log(`NFC íƒœê·¸ ê°ì§€: ${serialNumber}`);
                    
                    if (!gameState.hasScannedNFC) {
                        gameState.hasScannedNFC = true;
                        activateVIPMode();
                    } else {
                        showNotification('âœ¨ NFC íƒœê·¸ ì¸ì‹ë¨!', 'success');
                    }
                });

            } catch (error) {
                console.error('NFC ì—ëŸ¬:', error);
                showNotification('NFC ìŠ¤ìº”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
            }
        }

        // ëŸ¬ë‹ ì‹œì‘
        function startTracking() {
            if (!navigator.geolocation) {
                showNotification('ì´ ê¸°ê¸°ëŠ” ìœ„ì¹˜ ì„œë¹„ìŠ¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                return;
            }

            gameState.isTracking = true;
            currentPath = [];

            watchId = navigator.geolocation.watchPosition(
                (position) => {
                    const { latitude, longitude } = position.coords;
                    updateLocation(latitude, longitude);
                },
                (error) => {
                    console.error('ìœ„ì¹˜ ì—ëŸ¬:', error);
                    if (error.code === 1) {
                        showNotification('ìœ„ì¹˜ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤. ì„¤ì •ì—ì„œ í—ˆìš©í•´ì£¼ì„¸ìš”!', 'error');
                    } else {
                        showNotification('ìœ„ì¹˜ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    }
                },
                {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 5000
                }
            );

            document.getElementById('startButton').disabled = true;
            document.getElementById('stopButton').disabled = false;
            showNotification('ëŸ¬ë‹ì´ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸƒâ€â™‚ï¸', 'success');
        }

        // ëŸ¬ë‹ ì¤‘ì§€
        function stopTracking() {
            if (watchId) {
                navigator.geolocation.clearWatch(watchId);
            }

            gameState.isTracking = false;
            document.getElementById('startButton').disabled = false;
            document.getElementById('stopButton').disabled = true;
            showNotification('ëŸ¬ë‹ì´ ì¤‘ì§€ë˜ì—ˆìŠµë‹ˆë‹¤. ìˆ˜ê³ í•˜ì…¨ì–´ìš”! ğŸ’ª', 'success');
            saveGameState();
        }

        // ìœ„ì¹˜ ì—…ë°ì´íŠ¸
        function updateLocation(lat, lng) {
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            const icon = L.divIcon({
                html: 'ğŸ“',
                className: 'current-marker',
                iconSize: [30, 30]
            });

            currentMarker = L.marker([lat, lng], {icon: icon}).addTo(map);
            map.setView([lat, lng], map.getZoom());

            if (currentPath.length > 0) {
                const lastPoint = currentPath[currentPath.length - 1];
                const distance = calculateDistance(lastPoint[0], lastPoint[1], lat, lng);
                
                if (distance > 0.005) {
                    currentPath.push([lat, lng]);
                    
                    // VIPëŠ” 1.5ë°° ê±¸ìŒìˆ˜
                    const multiplier = gameState.isVIP ? 1.5 : 1;
                    gameState.distance += distance;
                    gameState.steps += Math.floor(distance * 1500 * multiplier);
                    
                    updatePath();
                    checkTurtleGrowth();
                    checkIslandProximity(lat, lng);
                    checkSecretLocations(lat, lng);
                    updateUI();
                    saveGameState();
                }
            } else {
                currentPath.push([lat, lng]);
            }
        }

        // ê²½ë¡œ ê·¸ë¦¬ê¸°
        function updatePath() {
            if (pathPolyline) {
                map.removeLayer(pathPolyline);
            }

            if (currentPath.length > 1) {
                pathPolyline = L.polyline(currentPath, {
                    color: '#667eea',
                    weight: 4,
                    opacity: 0.7
                }).addTo(map);
            }
        }

        // ê±°ë¦¬ ê³„ì‚°
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        // ê±°ë¶ì´ ì„±ì¥ ì²´í¬
        function checkTurtleGrowth() {
            for (let i = TURTLE_STAGES.length - 1; i >= 0; i--) {
                if (gameState.steps >= TURTLE_STAGES[i].stepsRequired && gameState.turtleStage < i) {
                    gameState.turtleStage = i;
                    gameState.level = i + 1;
                    showNotification(`ğŸ‰ ì¶•í•˜í•©ë‹ˆë‹¤! ${TURTLE_STAGES[i].name}ë¡œ ì„±ì¥í–ˆìŠµë‹ˆë‹¤!`, 'success');
                    break;
                }
            }
        }

        // ê±°ë¶ì„¬ ê·¼ì²˜ ì²´í¬
        function checkIslandProximity(lat, lng) {
            const distance = calculateDistance(lat, lng, TURTLE_ISLAND.lat, TURTLE_ISLAND.lng) * 1000;
            
            if (distance <= TURTLE_ISLAND.radius) {
                const hasIslandBadge = gameState.items.some(item => item.name === 'ê±°ë¶ì„¬ ë±ƒì§€');
                
                if (!hasIslandBadge) {
                    gameState.items.push(ITEMS[0]);
                    gameState.items.push(ITEMS[2]);
                    showNotification('ğŸŠ ê±°ë¶ì„¬ì— ë„ì°©í–ˆìŠµë‹ˆë‹¤! íŠ¹ë³„í•œ ì•„ì´í…œì„ ë°›ì•˜ì–´ìš”!', 'success');
                    updateItemsDisplay();
                    saveGameState();
                }
                
                document.getElementById('islandBadge').innerHTML = 
                    '<div class="turtle-island-badge">ğŸï¸ ê±°ë¶ì„¬ ë°©ë¬¸ ì¤‘</div>';
            } else {
                document.getElementById('islandBadge').innerHTML = '';
            }
        }

        // ë¹„ë°€ ì¥ì†Œ ì²´í¬ (VIP ì „ìš©)
        function checkSecretLocations(lat, lng) {
            if (!gameState.isVIP) return;

            SECRET_LOCATIONS.forEach(location => {
                const distance = calculateDistance(lat, lng, location.lat, location.lng) * 1000;
                
                if (distance <= location.radius) {
                    const hasReward = gameState.items.some(item => item.name === location.reward.name);
                    
                    if (!hasReward) {
                        gameState.items.push(location.reward);
                        showNotification(`âœ¨ ${location.name} ë°œê²¬! ${location.reward.icon} ${location.reward.name} íšë“!`, 'vip');
                        updateItemsDisplay();
                        saveGameState();
                    }
                }
            });
        }

        // UI ì—…ë°ì´íŠ¸
        function updateUI() {
            // ê±°ë¶ì´ í‘œì‹œ
            const stage = TURTLE_STAGES[gameState.turtleStage];
            const displayEmoji = gameState.customization.emoji || stage.emoji;
            document.getElementById('turtleEmoji').textContent = displayEmoji;
            
            // ì´ë¦„ í‘œì‹œ
            const displayName = gameState.customization.name || stage.name;
            document.getElementById('turtleName').textContent = displayName;
            if (gameState.isVIP) {
                document.getElementById('turtleName').classList.add('editable');
            }
            
            // ë ˆë²¨
            document.getElementById('turtleStage').textContent = `ë ˆë²¨ ${gameState.level}`;
            
            // í†µê³„
            document.getElementById('steps').textContent = gameState.steps.toLocaleString();
            document.getElementById('distance').textContent = gameState.distance.toFixed(2);
            document.getElementById('level').textContent = gameState.level;

            // í…Œë§ˆ ìƒ‰ìƒ ì ìš©
            const theme = COLOR_THEMES.find(t => t.name === gameState.customization.colorTheme) || COLOR_THEMES[0];
            document.querySelector('.status-section').style.background = theme.gradient;

            // ì§„í–‰ë°”
            let progress = 0;
            if (gameState.turtleStage < TURTLE_STAGES.length - 1) {
                const currentRequired = TURTLE_STAGES[gameState.turtleStage].stepsRequired;
                const nextRequired = TURTLE_STAGES[gameState.turtleStage + 1].stepsRequired;
                progress = ((gameState.steps - currentRequired) / (nextRequired - currentRequired)) * 100;
            } else {
                progress = 100;
            }
            document.getElementById('progressBar').style.width = Math.min(progress, 100) + '%';
        }

        // ì•„ì´í…œ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateItemsDisplay() {
            const grid = document.getElementById('itemsGrid');
            
            if (gameState.items.length === 0) {
                grid.innerHTML = '<div style="text-align: center; grid-column: 1/-1; color: #999; padding: 20px;">ì•„ì§ ì•„ì´í…œì´ ì—†ìŠµë‹ˆë‹¤. ê±°ë¶ì„¬ì„ ë°©ë¬¸í•´ë³´ì„¸ìš”! ğŸï¸</div>';
            } else {
                grid.innerHTML = gameState.items.map(item => {
                    const itemData = ITEMS.find(i => i.name === item.name);
                    const legendaryClass = itemData && itemData.legendary ? 'legendary' : '';
                    return `
                        <div class="item-card ${legendaryClass}">
                            <div class="item-icon">${item.icon}</div>
                            <div class="item-name">${item.name}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showNotification(text, type = 'success') {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = text;
            notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        // ì§„í–‰ìƒí™© ì´ˆê¸°í™”
        function resetProgress() {
            if (!confirm('ì •ë§ ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ? VIP ìƒíƒœëŠ” ìœ ì§€ë©ë‹ˆë‹¤.')) {
                return;
            }

            const wasVIP = gameState.isVIP;
            const customization = gameState.customization;

            gameState = {
                turtleStage: 0,
                steps: 0,
                distance: 0,
                level: 1,
                items: [],
                isTracking: false,
                hasScannedNFC: wasVIP,
                isVIP: wasVIP,
                customization: customization
            };

            currentPath = [];
            if (pathPolyline) {
                map.removeLayer(pathPolyline);
            }
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }

            updateUI();
            updateItemsDisplay();
            saveGameState();
            showNotification('ì§„í–‰ìƒí™©ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        }

        // ì €ì¥
        function saveGameState() {
            localStorage.setItem('turtleRunState', JSON.stringify(gameState));
        }

        // ë¶ˆëŸ¬ì˜¤ê¸°
        function loadGameState() {
            const saved = localStorage.getItem('turtleRunState');
            if (saved) {
                gameState = JSON.parse(saved);
                if (gameState.isVIP) {
                    document.getElementById('vipBadge').classList.add('active');
                    document.getElementById('customizeButton').classList.add('active');
                    showSecretLocations();
                }
                updateItemsDisplay();
            }
        }

        // í˜ì´ì§€ ë¡œë“œì‹œ ì´ˆê¸°í™”
        window.addEventListener('load', init);
    </script>
</body>
</html>
